<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Âπ∏ËøêËΩ¨Áõò</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@2.8.0/Winwheel.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #333);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* A nice container to hold the wheel and the pointer */
        .wheel-container {
            position: relative;
            width: 320px;
            height: 320px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* The Canvas */
        #wheelCanvas {
            z-index: 1;
            /* Add a subtle shadow behind the wheel */
            filter: drop-shadow(0px 8px 16px rgba(0,0,0,0.2)); 
        }

        /* The beautiful red pointer */
        .pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #e74c3c;
            z-index: 10;
            filter: drop-shadow(0px 4px 4px rgba(0,0,0,0.3));
        }

        /* Inner circle decoration */
        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background-color: #fff;
            border-radius: 50%;
            border: 6px solid #e74c3c;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: #e74c3c;
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.3);
        }

        button.spin-btn {
            background-color: var(--tg-theme-button-color, #e74c3c);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 16px 45px;
            font-size: 20px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 6px 0 #c0392b, 0 10px 10px rgba(0,0,0,0.2);
            transition: all 0.1s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button.spin-btn:active {
            transform: translateY(6px);
            box-shadow: 0 0px 0 #c0392b, 0 4px 4px rgba(0,0,0,0.2);
        }
        
        #result-text {
            margin-top: 25px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            min-height: 28px;
            color: var(--tg-theme-text-color, #333);
        }
    </style>
</head>
<body>

    <h2 id="greeting" style="margin-bottom: 20px;">üé∞ Âπ∏ËøêËΩ¨Áõò üé∞</h2>

    <div class="wheel-container">
        <div class="pointer"></div>
        <canvas id="wheelCanvas" width="320" height="320">
            Canvas not supported.
        </canvas>
        <div class="center-circle">GO</div>
    </div>

    <button class="spin-btn" onclick="startSpin()" id="spinBtn">üéü ÊäΩÂ•ñ</button>
    <div id="result-text"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            document.getElementById('greeting').innerText = `Ê¨¢Ëøé, ${tg.initDataUnsafe.user.first_name}!`;
        }

        let theWheel;
        let isSpinning = false;
        let wheelData = [];

        // Beautiful pre-selected colors
        const colors = ["#feca57", "#ff6b6b", "#48dbfb", "#1dd1a1", "#ff9f43", "#5f27cd", "#c8d6e5"];

        // --- 1. Load Data & Initialize Winwheel ---
        async function loadWheelData() {
            try {
                const response = await fetch('/api/wheel_data');
                wheelData = await response.json();
                
                // Map the Python data into Winwheel's required format
                let winwheelSegments = wheelData.map((sector, i) => {
                    return {
                        'id': sector.id,
                        'fillStyle': colors[i % colors.length],
                        'text': sector.name.length > 8 ? sector.name.substring(0,8) + ".." : sector.name,
                        'size': sector.chance * 360, // Directly converts chance (0.0 - 1.0) into degrees!
                        'textFontSize': 14,
                        'textFillStyle': '#ffffff'
                    };
                });

                // Create the Wheel Object!
                theWheel = new Winwheel({
                    'numSegments': winwheelSegments.length,
                    'outerRadius': 150,
                    'textFontSize': 16,
                    'textOrientation': 'horizontal', 
                    'textAlignment': 'outer',
                    'segments': winwheelSegments,
                    'lineWidth': 2,
                    'strokeStyle': '#ffffff',
                    'animation': {
                        'type': 'spinToStop',
                        'duration': 4, // 4 seconds of spinning
                        'spins': 7,    // 7 full rotations before stopping
                        'easing': 'Power3.easeOut', // Super smooth slow-down effect
                        'callbackFinished': 'alertPrize()'
                    }
                });

            } catch (error) {
                document.getElementById('result-text').innerText = "Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï";
            }
        }

        // --- 2. Handle Spin Logic ---
        async function startSpin() {
            if (isSpinning) return;
            isSpinning = true;

            document.getElementById('result-text').innerText = "üé∞ ÊäΩÂ•ñ‰∏≠...";
            document.getElementById('spinBtn').style.opacity = "0.5";

            try {
                // Fetch the winning index securely from Python
                const response = await fetch('/api/spin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData }) 
                });
                
                const result = await response.json();

                if (!response.ok) {
                    tg.showAlert(result.error || "ÂèëÁîüÈîôËØØ!");
                    resetUI();
                    return;
                }

                const winningId = result.winning_id;
                let targetSegment = 1; // Default to first segment if not found
                
                for (let i = 1; i <= theWheel.numSegments; i++) {
                    if (theWheel.segments[i].id === winningId) {
                        targetSegment = i;
                        break;
                    }
                }
                
                // Reset the wheel's rotation just in case they are spinning a 2nd time
                theWheel.stopAnimation(false);
                theWheel.rotationAngle = theWheel.rotationAngle % 360;

                // Winwheel magically calculates the exact angle to land on!
                let stopAt = theWheel.getRandomForSegment(targetSegment);
                
                theWheel.animation.stopAngle = stopAt;
                
                // Start the smooth animation
                theWheel.startAnimation();

            } catch (error) {
                tg.showAlert("ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ");
                resetUI();
            }
        }

        // --- 3. Finished Callback ---
        // This is automatically called by Winwheel when the spinning completely stops
        function alertPrize() {
            const winningSegment = theWheel.getIndicatedSegment();
            document.getElementById('result-text').innerText = `üéâ ÁªìÊûú: ${winningSegment.text}`;
            
            // Check if it's the "Lose" slice (We named it "Ë∞¢Ë∞¢ÊÉ†È°æ" in Python)
            if (winningSegment.text === "Ë∞¢Ë∞¢ÊÉ†È°æ") {
                tg.HapticFeedback.notificationOccurred("warning"); 
            } else {
                tg.HapticFeedback.notificationOccurred("success"); 
            }
            
            resetUI();
        }

        function resetUI() {
            isSpinning = false;
            document.getElementById('spinBtn').style.opacity = "1";
        }

        // Boot it up!
        loadWheelData();
    </script>
</body>
</html>